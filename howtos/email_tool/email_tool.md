## Introduction
For purpose of sending personalised emails to selected users, was created service account robot@muni.dev. SMTP client is mailrelay.muni.dev and for corrects function of sending mail via python smtpclient needs this account to be added to kerberos realm.

Newly is added generatemail.py script which only generate email communication based on provided data from templates. 

## How to use sendmail.py
You need to have installed requirements
```
pip install -r requirements.txt
```

Password and other iformation about service account you can obtain in infra-config repository.

In users.csv is a list of users to where mails will be sent in format name;email;project_name;note 

Example of executing script:
```
python3 sendmail.py -c users.csv -t template -e cloud@metacentrum.cz -S SUBJECT -r cloud@metacentrum.cz -s "mailrelay.muni.dev" -p 587 -u robot@muni.dev -w '<password>'
```

Content of email message you can modify easily in template.html and template.txt. Data from users.csv can be used inside template by referencing them inside brackets eg. `{{ name }}`.

Arguments:
```
-c  --csv           Path to CSV file containing email addresses and names
-t  --template'     Name of the Jinja2 template located in the folder - there should be two files: template.txt and template.html
-e  --email         Sender email address
-r  --reply         Reply-to email address
-S  --subject'      Email subject
-s  --smtp_server   SMTP server address
-p  --smtp_port     SMTP server port
-u  --username      SMTP server username
-w  --password      SMTP server password
--html2text         Generate plaintext mail part from HTML template. The *.txt template file will be ignored. Off by default.
--sendemail         Actually sends mail to defined address, by default its false and only generates email content and prints it.
```

## How to use generatemail.py
You need to have installed requirements
```
pip install -r requirements.txt
```

In *.csv files you can see examples of data which is parsed into templates which generates final email.
Running it with multiple rows in .gitlab-ci generates *.txt output in artifacts for each row and write the last generated mail of every template to console.
*.csv file contains infromation which are parse into templates. So we need to provide this information it's separated by ; and column's needs to be in exact name that is in templates eg. `{{ project_name }}`. Some column's can link to other .csv files if it's needed, for example if i have multiple migrated servers i have to link servers.csv where is stored data about migrated servers, name of the csv files have to correspond with the one used in template. Generated templates are saved in *.txt files named after `template`-`project_name`.txt. 

Script generatemail.py is possible to use in gitlab pipeline job `generate-communication` which possibly have 2 parameters:
```
CSV_FILE           Relative path to .csv file containing data which is parsed into tempaltes.
TEMPLATE           Relative path to concerete template. If empty, then all templates will be used.
```

Gitlab pipeline contains also job `generate-communication-trigger` which is triggered by ostack-einfra_cz-trigger-communication-generation from g1-g2-ostack-cloud-migration repository where needed data is generated by `ostack-einfra_cz-trigger-communication-generation` job and termplate as well howtos/email_tool/g1-g2-migration/templates/mail-final_project-migrated.tmpl. This job generates just final mail to send to user.

Job `ostack-einfra_cz-trigger-communication-generation` takes possibly 3 parameters and based on provided information it generates `data.csv` and `servers.csv` files. Next it creates data.zip and protects it by password, using base64 encryption it creates text representation of file, which is send by curl to url, which triggers pipeline `generate-communication-trigger` with provided data.

Description of parameters for job `ostack-einfra_cz-trigger-communication-generation`:
```
PROJECT_NAME               Name of migrated project
PROJECT_EXPIRATION         Expiration of migrated project
MIGRATION_DATE             Date when project was migrated, if left empty, then actual date is used(today).
```

Example of executing script which generates output for specific template
```
python3 generatemail.py -c users.csv -t template -S SUBJECT --html2text
```
If -t is not used, then it will generate mails for all possible templates
```
python3 generatemail.py -c users.csv -S SUBJECT --html2text
```
Content of email message you can modify easily in template.html and template.tmpl. Data from *.csv can be used inside template by referencing them inside brackets eg. `{{ project_name }}`.

Arguments:
```
-c  --csv           Path to CSV file containing email addresses and names
-t  --template'     Name of the Jinja2 template located in the folder - there should be two files: template.txt and template.html
--html2text         Generate plaintext mail part from HTML template. The *.txt template file will be ignored. Off by default.
```
