# g1-g2 migration e-mail tooling

## Introduction

See the general info about the [email tool](../email_tool.md).

This folder contains files specific to a g1-to-g2 migration e-mail campaign.

There is no `*.txt` template file present. The plaintext part of the e-mail will be generated by the `sendmail.py` / `generatemail.py` scripts
through the use of the `--html2text` flag (see below).

## How to use

Prerequisites
```bash
$ pip install -r requirements.txt

$ cd <repo_root>/howtos/email_tool/
```

### Send e-mails automatically

Send an initial e-mail to each project in `projects-data.csv`:
```bash
$ python3 sendmail.py \
-c ./g1-g2-migration/projects-data/projects-data.csv \
-t ./g1-g2-migration/templates/template \
-e cloud@metacentrum.cz \
-S "$(cat ./g1-g2-migration/templates/subject.txt)" \
-r cloud@metacentrum.cz \
-s "mailrelay.muni.dev" \
-p 587 \
-u 9047620@is.muni.dev \
-w '<password>' \
--html2text \
--sendemail \
--recipients cloud@metacentrum.cz
```

Prepare data for stalled projects:
```bash
$ cat ./stalled-projects-data.csv
project_name;emails_to;emails_cc;project_expiration;migration_date;migration_prep_deadline;rt_id;signature
js-test;smrk@muni.dev;josef@muni.dev;31.12.2030;3.9.2024;26.8.2024 9:00;https://rt.muni.dev/rt/Ticket/Display.html?id=1234567;Josef
js-test-2;smrk@muni.dev;josef@muni.dev;31.12.2030;10.9.2024;26.8.2024 9:00;https://rt.muni.dev/rt/Ticket/Display.html?id=7654321;Josef

$ ./replace-rt-links-with-ids.sh ./stalled-projects-data.csv

$ cat ./stalled-projects-data.csv
project_name;emails_to;emails_cc;project_expiration;migration_date;migration_prep_deadline;rt_id;signature
js-test;smrk@muni.dev;josef@muni.dev;31.12.2030;3.9.2024;26.8.2024 9:00;1234567;Josef
js-test-2;smrk@muni.dev;josef@muni.dev;31.12.2030;10.9.2024;26.8.2024 9:00;7654321;Josef
```

Send a reminder e-mail to stalled projects:
```bash
$ python3 sendmail.py \
-c ./g1-g2-migration/projects-data/stalled-projects-data.csv \
-t ./g1-g2-migration/templates/template-stalled-projects \
-e cloud@metacentrum.cz \
-S "$(cat ./g1-g2-migration/templates/subject.txt)" \
--subject_prefix "$(cat ./g1-g2-migration/templates/mail-stalled-subject-prefix.txt)" \
-r cloud@metacentrum.cz \
-s "mailrelay.muni.dev" \
-p 587 \
-u robot@muni.dev \
-w '<***password***>' \
--html2text \
--sendemail \
--recipients cloud@metacentrum.cz
```

## Generate e-mails (send manually / paste text in RT)

To generate a single e-mail for each project, specify a template:
```bash
$ python3 generatemail.py \
-c ./g1-g2-migration/projects-data/projects-data.csv \
-t ./g1-g2-migration/templates/template \
-S "$(cat ./g1-g2-migration/templates/subject.txt)" \
--html2text
```

To generate all available e-mails for each project, do not specify a template:
```bash
$ python3 generatemail.py \
-c ./g1-g2-migration/projects-data/projects-data.csv \
-S "$(cat ./g1-g2-migration/templates/subject.txt)" \
--html2text
```

## templates

`subject.txt` - E-mail subject template - common for all e-mails.

`mail-1*` - Initial announcemet.

`mail-2*` - Reminder. Select a template based on the project status (regular / expired / empty).

`mail-final*` - Send at the end of current batch processing. Select a template based on the project status (migrated / expired / empty).
- Applicable in both the old and the new system of migration planning (see bellow).

`mail-stalled*` - Re-address stalled projects, which have been announced before and users did not respond.
- This e-mail should be added to existing ticket. To achieve it, use `--subject_prefix "$(cat ...mail-stalled-subject-prefix.txt)"`.

`mail-stalled-subject-prefix.txt` - Subject prefix for stalled projects.
- Make sure there is `rt_id` column in projects data CSV file. See `tmpl-stalled-projects-data.csv`.

`old_*` - Use in the old system of migration planning:
- new batch of ~15 projects every week
- send `mail-1` 2 weeks in advance
- send `mail-2` 1 week in advance
- communication and projects inspection takes place between `mail-1` and migration date

Other (non `old_*`) templates are applicable in the new system:
- new batch of ~30 projects every 2 weeks (sprint)
- send `mail-1` at the end of `sprint(x)`
- send `mail-2` in the middle of `sprint(x+1)`
- communication and projects inspection takes place during `sprint(x+1)`
- communication and projects inspection deadline at the end of `sprint(x+1)`
- migration takes place during `sprint(x+2)` - 15 + 15 projects each week


## projects-data

`tmpl-projects-data.csv` - Template of files with projects data, which are needed for all variations of `mail-1` and `mail-2`, as well as for `mail-final_project-empty.tmpl` and `mail-final_project-expired.tmpl`.
- `old_tmpl-projects-data.csv` - The same in the old system of migration planning.

`tmpl-migrated-projects-data.csv` - Template of files with projects data, which are needed for `mail-final_project-migrated.tmpl`.
- `tmpl-migrated-project-servers.csv` - Template of files with (single) project data about migrated servers. Referenced from `tmpl-migrated-project-data.csv`.
- Use when you want to generate final mails about migrated projects manually.

`tmpl-stalled-projects-data.csv` - Template of files with stalled projects data.
- The same as `tmpl-projects-data.csv` plus an `rt_id` column, which contains IDs of RT tickets of the stalled projects.

`sent_*` - Projects data of a batch, which the `mail-1` has been sent.
- We store these files to keep additional track of processed projects, but the main source of truth about projects and their migration progress
  is https://docs.google.com/spreadsheets/d/*******************************
